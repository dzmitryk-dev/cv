name: Generate CV and Create Release

on:
  # Trigger on git tags (for versioned releases)
  push:
    tags:
      - 'v*'
      - 'release-*'
  
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (optional)'
        required: false
        default: ''
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

  # Trigger on changes to CV content (optional - uncomment if desired)
  # push:
  #   branches: [ main, master ]
  #   paths:
  #     - 'content/**'
  #     - 'template/**'

jobs:
  generate-cv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Make scripts executable
      run: |
        chmod +x build_html.sh
        chmod +x docker/scripts/build.sh
        chmod +x docker/scripts/generate.sh
        
    - name: Build Docker image
      run: make image
      
    - name: Generate CV using Docker
      run: make pdf
      
    - name: Verify generated files
      run: |
        echo "Checking generated files..."
        ls -la dist/
        
        if [ ! -f "dist/cv.html" ]; then
          echo "âŒ Error: cv.html not found"
          exit 1
        fi
        
        if [ ! -f "dist/cv.pdf" ]; then
          echo "âŒ Error: cv.pdf not found"
          exit 1
        fi
        
        echo "âœ… Both HTML and PDF files generated successfully"
        
    - name: Get file sizes and info
      run: |
        echo "Generated files:"
        echo "HTML: $(ls -lh dist/cv.html | awk '{print $5}')"
        echo "PDF: $(ls -lh dist/cv.pdf | awk '{print $5}')"
        
    - name: Prepare release assets
      run: |
        # Create a release directory
        mkdir -p release
        
        # Copy files with descriptive names
        cp dist/cv.html "release/CV-$(date +%Y%m%d).html"
        cp dist/cv.pdf "release/CV-$(date +%Y%m%d).pdf"
        
        # Also keep original names for consistency
        cp dist/cv.html release/
        cp dist/cv.pdf release/
        
        echo "Release assets prepared:"
        ls -la release/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cv-files
        path: |
          release/
          dist/
        retention-days: 30
        
    - name: Determine release info
      id: release_info
      run: |
        # Set release name
        if [ "${{ github.event.inputs.release_name }}" != "" ]; then
          RELEASE_NAME="${{ github.event.inputs.release_name }}"
        elif [ "${{ github.ref_type }}" == "tag" ]; then
          RELEASE_NAME="${{ github.ref_name }}"
        else
          RELEASE_NAME="CV Release $(date +%Y-%m-%d)"
        fi
        
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        
        # Set tag name (create one if triggered manually)
        if [ "${{ github.ref_type }}" == "tag" ]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          TAG_NAME="cv-$(date +%Y%m%d-%H%M%S)"
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        
        # Set prerelease flag
        PRERELEASE="false"
        if [ "${{ github.event.inputs.prerelease }}" == "true" ]; then
          PRERELEASE="true"
        fi
        
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        
        echo "Release will be created with:"
        echo "  Name: $RELEASE_NAME"
        echo "  Tag: $TAG_NAME" 
        echo "  Prerelease: $PRERELEASE"
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        release_name: ${{ steps.release_info.outputs.release_name }}
        draft: false
        prerelease: ${{ steps.release_info.outputs.prerelease }}
        body: |
          ## CV Files Generated ğŸ“„
          
          This release contains the latest version of the CV in both HTML and PDF formats.
          
          ### ğŸ“ Files Included:
          - **CV.pdf** - PDF version with preserved styling and backgrounds
          - **CV.html** - Web version for online viewing
          - **CV-YYYYMMDD.pdf** - Dated PDF version
          - **CV-YYYYMMDD.html** - Dated HTML version
          
          ### ğŸ¨ Features:
          - Professional VS Code dark theme aesthetic
          - Print-optimized A4 formatting
          - Background colors and styling preserved in PDF
          - Responsive design for all devices
          
          ### ğŸ”„ Generated on: $(date)
          
          Generated automatically from the latest CV content using GitHub Actions.
          
    - name: Upload PDF Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/cv.pdf
        asset_name: CV.pdf
        asset_content_type: application/pdf
        
    - name: Upload HTML Release Asset  
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/cv.html
        asset_name: CV.html
        asset_content_type: text/html
        
    - name: Upload Dated PDF Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/CV-$(date +%Y%m%d).pdf
        asset_name: CV-$(date +%Y%m%d).pdf
        asset_content_type: application/pdf
        
    - name: Upload Dated HTML Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/CV-$(date +%Y%m%d).html
        asset_name: CV-$(date +%Y%m%d).html
        asset_content_type: text/html
        
    - name: Display release info
      run: |
        echo "ğŸ‰ Release created successfully!"
        echo "ğŸ“ Release URL: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ”— You can download the CV files from the release page"
        echo ""
        echo "ğŸ“ Direct download links:"
        echo "  PDF: ${{ steps.create_release.outputs.html_url }}/download/CV.pdf"
        echo "  HTML: ${{ steps.create_release.outputs.html_url }}/download/CV.html"